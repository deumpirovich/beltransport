<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Транспорт Минска — поставки</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; background: #f5f7fa; color: #23263a; margin: 0; padding: 0;}
    .cont { max-width: 1100px; margin: 15px auto; padding: 0 10px; }

    .stickyTop{
      position: sticky;
      top: 0;
      z-index: 100;
      background: #f5f7fa;
      padding-top: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e3e8f5;
    }

    .msg {color:#b25127;margin:5px 0; line-height:1.25;}
    .topbar{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .search {margin:6px 0 7px 0; display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .tabs{display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 4px 0;}
    .tab{padding:3px 10px; border-radius:10px; border:1px solid #cfd7ea; background:#eef3ff; cursor:pointer; user-select:none; font-size:12px; white-space:nowrap;}
    .tab.active{background:#2543a5; color:#fff; border-color:#2543a5;}
    .counts{color:#5b6b98; font-size:12px; margin-left:auto;}

    .btn{
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid #cfd7ea;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      color:#2543a5;
      user-select:none;
    }
    .btn:hover{ background:#f6f9ff; }

    .tableWrap{margin-top:8px;}
    table { width: 100%; border-collapse: collapse; background:#fff; border-radius:8px; overflow:hidden; font-size:13px; }
    table#tbl{ table-layout: fixed; }

    th, td { padding: 6px 6px; text-align: center; vertical-align: middle; }
    thead th{
      position: static;
      background:#ecf1fa;
      border-bottom: 1.5px solid #abc;
    }

    td, th{
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    th { color: #2543a5; font-weight: 600; cursor: pointer; user-select: none; position: relative; }
    th.active { background: #d2e3ff; }
    tr { border-bottom: 1px solid #eee;}
    tr:hover { background: #f0f5ff;}
    .num { font-weight: bold; color: #2543a5; }
    .no { color:#bbb; font-style:italic; }
    .empty {padding:18px 0; text-align:center; color:#9aa6c3; font-style:italic;}
    .err {margin-top:8px; padding:6px 10px; background:#ffecec; border:1px solid #f2b0b0; border-radius:6px; color:#8b1e1e; font-size:12px; white-space:pre-wrap;}

    thead tr.filters th{
      background:#ecf1fa;
      border-bottom: 1.5px solid #abc;
      padding: 4px 6px 6px 6px;
      cursor: default;
    }
    .colFilter{
      width: 100%;
      box-sizing: border-box;
      padding: 3px 6px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #bbc;
      outline: none;
      background: #fff;
      text-align: left;
    }
    .colFilter:focus{ border-color:#2543a5; }

    /* ===== Excel-like resizer (DESKTOP ONLY will be enabled by JS) ===== */
    .resizer{
      position:absolute;
      top:0;
      right:-4px;
      width:8px;
      height:100%;
      cursor: col-resize;
      user-select:none;
      touch-action:none;
      z-index:5;
    }
    th:hover .resizer::after{
      content:'';
      position:absolute;
      top:0; bottom:0;
      left:3px;
      width:2px;
      background: rgba(37,67,165,.35);
    }
    .resizing, .resizing *{ cursor: col-resize !important; user-select:none !important; }

    /* Default widths */
    col.c-type   { width: 9%;  }
    col.c-model  { width: 20%; }
    col.c-year   { width: 6%;  }
    col.c-date   { width: 9%;  }
    col.c-park   { width: 7%;  }
    col.c-num    { width: 10%; }
    col.c-factory{ width: 14%; }
    col.c-garage { width: 11%; }
    col.c-color  { width: 14%; }

    @media (max-width: 720px){
      .cont{margin:10px auto;}
      .counts{margin-left:0;}
      th, td{padding:6px 5px;}
      table{font-size:12px;}
      .tab{padding:3px 8px;}
      /* на мобиле кнопку сброса можно спрятать, но оставляю */
    }

    /* ===== Row details modal ===== */
    #rowModal{ position: fixed; inset: 0; z-index: 1000; display:none; }
    #rowModal .rm-backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.35); }
    #rowModal .rm-sheet{
      position:absolute; left:0; right:0; bottom:0;
      background:#fff;
      border-radius: 14px 14px 0 0;
      box-shadow: 0 -10px 25px rgba(0,0,0,.2);
      max-height: 78vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    #rowModal .rm-head{
      position: sticky; top: 0;
      background:#fff;
      padding: 10px 12px;
      border-bottom: 1px solid #eef1f7;
      display:flex; align-items:center; gap:10px;
    }
    #rowModal .rm-title{ font-weight: 700; color:#2543a5; }
    #rowModal .rm-close{
      margin-left:auto;
      border:1px solid #d6deef;
      background:#f6f9ff;
      border-radius: 10px;
      width: 34px; height: 30px;
      cursor:pointer;
      font-size: 18px;
      line-height: 26px;
    }
    #rowModal .rm-body{ padding: 10px 12px 16px 12px; }
    .rm-row{ display:flex; gap:10px; padding: 8px 0; border-bottom: 1px dashed #eef1f7; }
    .rm-k{ width: 110px; flex: 0 0 110px; color:#5b6b98; font-size:12px; }
    .rm-v{ flex: 1 1 auto; color:#23263a; word-break: break-word; }

    @media (min-width: 721px){
      #rowModal .rm-sheet{
        left: 50%;
        transform: translateX(-50%);
        width: 520px;
        border-radius:14px;
        top: 12vh;
        bottom:auto;
        max-height: 76vh;
      }
    }
  </style>
</head>
<body>
<div class="cont">
  <div class="stickyTop" id="stickyTop">
    <div class="topbar">
      <div class="msg">
        <span id="monthHint" style="color:#5b6b98;"></span>
      </div>
      <div class="counts"><span id="countShown">0</span> / <span id="countAll">0</span></div>
      <button class="btn" id="btnResetCols" title="Сбросить сохранённые ширины столбцов">Сброс ширин</button>
    </div>

    <div class="search">
      <div style="color:#5b6b98;font-size:12px;" id="updatedAt"></div>
    </div>

    <div class="tabs" id="tabs"></div>
  </div>

  <div class="tableWrap">
    <table id="tbl">
      <colgroup>
        <col class="c-type" data-colkey="type">
        <col class="c-model" data-colkey="model">
        <col class="c-year" data-colkey="year">
        <col class="c-date" data-colkey="deliveryDate">
        <col class="c-park" data-colkey="park">
        <col class="c-num" data-colkey="vehicleNumber">
        <col class="c-factory" data-colkey="factoryNumber">
        <col class="c-garage" data-colkey="garageNumber">
        <col class="c-color" data-colkey="color">
      </colgroup>

      <thead>
        <tr>
          <th data-f="type" data-colkey="type">Тип</th>
          <th data-f="model" data-colkey="model">Модель</th>
          <th data-f="year" data-colkey="year">Год</th>
          <th data-f="deliveryDate" data-colkey="deliveryDate">Дата</th>
          <th data-f="park" data-colkey="park">Парк</th>
          <th data-f="vehicleNumber" data-colkey="vehicleNumber" class="active">Номер</th>
          <th data-f="factoryNumber" data-colkey="factoryNumber">Заводской №</th>
          <th data-f="garageNumber" data-colkey="garageNumber">Гаражный №</th>
          <th data-f="color" data-colkey="color">Цвет</th>
        </tr>

        <tr class="filters">
          <th><input class="colFilter" data-col="type"></th>
          <th><input class="colFilter" data-col="model"></th>
          <th><input class="colFilter" data-col="year"></th>
          <th><input class="colFilter" data-col="deliveryDate"></th>
          <th><input class="colFilter" data-col="park"></th>
          <th><input class="colFilter" data-col="vehicleNumber"></th>
          <th><input class="colFilter" data-col="factoryNumber"></th>
          <th><input class="colFilter" data-col="garageNumber"></th>
          <th><input class="colFilter" data-col="color"></th>
        </tr>
      </thead>

      <tbody id="data"></tbody>
    </table>
  </div>

  <div class="empty" id="empty" style="display:none;">Нет данных по фильтру</div>
  <div class="err" id="err" style="display:none;"></div>
</div>

<div id="rowModal">
  <div class="rm-backdrop"></div>
  <div class="rm-sheet" role="dialog" aria-modal="true">
    <div class="rm-head">
      <div class="rm-title" id="rmTitle">Детали</div>
      <button class="rm-close" id="rmClose" type="button">×</button>
    </div>
    <div class="rm-body" id="rmBody"></div>
  </div>
</div>

<script>
const JSON_URL = './postavki.json';
const COLS_STORAGE_KEY = 'postavki_col_widths_v2';
const ENABLE_RESIZE_MIN_WIDTH = 900; // ресайз только на “десктопе/планшете”

let DATA = [];
let VIEW = [];
let sortF = "vehicleNumber";
let sortDesc = true;

let activeTab = "_new";
let newMonthKey = '';
let hasCurrentMonth = false;

function pad2(n){ return String(n).padStart(2,'0'); }
function monthKeyFromDeliveryDate(s){
  const m = String(s||'').trim().match(/^(\d{1,2})\.(\d{4})$/);
  if(!m) return '';
  return `${pad2(m[1])}.${m[2]}`;
}
function currentMonthKey(){
  const d = new Date();
  return `${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
}
function computeNewMonthKey(){
  const months = new Set();
  DATA.forEach(v=>{
    const mk = monthKeyFromDeliveryDate(v.deliveryDate);
    if(mk) months.add(mk);
  });

  if(!months.size){
    newMonthKey = '';
    hasCurrentMonth = false;
    document.getElementById('monthHint').textContent = '';
    return;
  }

  const cur = currentMonthKey();
  hasCurrentMonth = months.has(cur);

  if(hasCurrentMonth){
    newMonthKey = cur;
  } else {
    newMonthKey = [...months].sort((a,b)=>{
      const [am,ay]=a.split('.'); const [bm,by]=b.split('.');
      return Number(by+bm) - Number(ay+am);
    })[0];
  }

  document.getElementById('monthHint').textContent =
    newMonthKey ? `NEW: ${newMonthKey}${hasCurrentMonth ? '' : ' (последний месяц с поставками)'}` : '';
}

function normType(t){
  t = (t||'').toString().trim().toLowerCase();
  if(t === 'уах') t = 'туах';
  return t;
}
function typeLabel(t){
  t = normType(t);
  if(t === 'автобус') return 'Автобус';
  if(t === 'троллейбус') return 'Троллейбус';
  if(t === 'трамвай') return 'Трамвай';
  if(t === 'электробус') return 'Электробус';
  if(t === 'туах') return 'ТУАХ';
  return t ? (t[0].toUpperCase()+t.slice(1)) : '—';
}

const TAB_ORDER = [
  {key:'_new', label:'NEW'},
  {key:'автобус', label:'Автобус'},
  {key:'троллейбус', label:'Троллейбус'},
  {key:'трамвай', label:'Трамвай'},
  {key:'электробус', label:'Электробус'},
  {key:'туах', label:'ТУАХ'},
  {key:'_all', label:'Все'}
];

function calcTypeCounts(){
  const m = {};
  DATA.forEach(v=>{
    const t = normType(v.type);
    if(!t) return;
    m[t] = (m[t]||0)+1;
  });
  return m;
}
function countForNew(){
  if(!newMonthKey) return 0;
  return DATA.filter(v => monthKeyFromDeliveryDate(v.deliveryDate) === newMonthKey).length;
}

function renderTabs(){
  const wrap = document.getElementById('tabs');
  const typeCounts = calcTypeCounts();
  const newCount = countForNew();

  wrap.innerHTML = TAB_ORDER.map(t => {
    let c = 0;
    if(t.key === '_new') c = newCount;
    else if(t.key === '_all') c = DATA.length;
    else c = (typeCounts[t.key] || 0);

    return `<div class="tab ${activeTab===t.key?'active':''}" data-tab="${t.key}">
      ${t.label} <span style="opacity:.75;">${c}</span>
    </div>`;
  }).join('');

  wrap.querySelectorAll('.tab').forEach(el=>{
    el.onclick = ()=>{
      activeTab = el.getAttribute('data-tab');
      renderTabs();
      render();
    };
  });
}

/* ===== Sorting rules ===== */
const SERIES_ORDER = "ABEIKMHOPCTX";
const SERIES_WEIGHT = (() => {
  const m = {};
  for(let i=0;i<SERIES_ORDER.length;i++) m[SERIES_ORDER[i]] = i;
  return m;
})();

function canonSeriesChar(ch){
  ch = (ch || '').toString().toUpperCase();
  if(Object.prototype.hasOwnProperty.call(SERIES_WEIGHT, ch)) return ch;
  const ru2lat = {'А':'A','В':'B','Е':'E','И':'I','І':'I','К':'K','М':'M','Н':'H','О':'O','Р':'P','С':'C','Т':'T','Х':'X'};
  return ru2lat[ch] || ch;
}
function normVehicleNumberForSort(s){
  s = (s || '').toString().trim().toUpperCase();
  s = s.replace(/\s+/g, '');
  s = s.replace(/[A-ZА-ЯІ]/g, ch => canonSeriesChar(ch));
  return s;
}
function isPlateDash7(s){ return /^[A-Z0-9]{6}-7$/.test(s); }
function plateGroupThirdChar(normS){
  const ch3 = normS[2] || '';
  return /\d/.test(ch3) ? 0 : 1;
}
function compareVehicleStringsAsc(a, b){
  const n = Math.max(a.length, b.length);
  for(let i=0;i<n;i++){
    const ac = a[i] || '';
    const bc = b[i] || '';
    if(ac === bc) continue;
    if(!ac) return -1;
    if(!bc) return 1;

    const aw = Object.prototype.hasOwnProperty.call(SERIES_WEIGHT, ac) ? SERIES_WEIGHT[ac] : null;
    const bw = Object.prototype.hasOwnProperty.call(SERIES_WEIGHT, bc) ? SERIES_WEIGHT[bc] : null;

    if(aw !== null && bw !== null) return aw - bw;
    if(aw !== null && bw === null) return -1;
    if(aw === null && bw !== null) return 1;

    if(ac < bc) return -1;
    if(ac > bc) return 1;
  }
  return 0;
}
function numSortAlg(a, b){
  const anRaw = (a.vehicleNumber || '').toString().trim();
  const bnRaw = (b.vehicleNumber || '').toString().trim();

  if(!anRaw && !bnRaw) return 0;
  if(!anRaw) return 1;
  if(!bnRaw) return -1;

  const an = normVehicleNumberForSort(anRaw);
  const bn = normVehicleNumberForSort(bnRaw);

  const tA = normType(a.type);
  const tB = normType(b.type);
  const applyThirdRuleA = (tA === 'автобус' || tA === 'электробус');
  const applyThirdRuleB = (tB === 'автобус' || tB === 'электробус');

  const aDash7 = isPlateDash7(an);
  const bDash7 = isPlateDash7(bn);

  if(applyThirdRuleA && applyThirdRuleB && aDash7 && bDash7){
    const aG = plateGroupThirdChar(an);
    const bG = plateGroupThirdChar(bn);
    if(aG !== bG) return bG - aG;
  }

  const r = compareVehicleStringsAsc(an, bn);
  if(r !== 0) return r;

  const aU = anRaw.toUpperCase();
  const bU = bnRaw.toUpperCase();
  if(aU < bU) return -1;
  if(aU > bU) return 1;
  return 0;
}
function normFactoryForSort(s){
  s = (s || '').toString().trim().toUpperCase();
  s = s.replace(/[\s\-]/g, '');
  const map = {'А':'A','В':'B','С':'C','Е':'E','Н':'H','К':'K','М':'M','О':'O','Р':'P','Т':'T','Х':'X','У':'Y'};
  s = s.replace(/[АВСЕНКМОРТХУ]/g, ch => map[ch] || ch);
  return s;
}
function generalSort(a, b){
  if(sortF === "vehicleNumber") {
    const r = numSortAlg(a, b);
    return sortDesc ? -r : r;
  }
  let av, bv;
  if(sortF === "factoryNumber"){
    av = normFactoryForSort(a.factoryNumber);
    bv = normFactoryForSort(b.factoryNumber);
  } else {
    av = (a[sortF]||'').toLowerCase();
    bv = (b[sortF]||'').toLowerCase();
  }
  if(av < bv) return sortDesc ? 1 : -1;
  if(av > bv) return sortDesc ? -1 : 1;

  const r2 = numSortAlg(a, b);
  return sortDesc ? -r2 : r2;
}

/* ===== render helpers ===== */
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function cell(x){
  const s = (x||'').toString().trim();
  return s ? escapeHTML(s) : '<span class="no">—</span>';
}
function normVehicleNumberForSearch(s){
  s = (s || '').toString().trim().toUpperCase();
  s = s.replace(/[\s\-]/g, '');
  const map = {'A':'А','B':'В','C':'С','E':'Е','H':'Н','K':'К','M':'М','O':'О','P':'Р','T':'Т','X':'Х','Y':'У','I':'И','І':'И'};
  s = s.replace(/[ABCEHKMOPTXYIІ]/g, ch => map[ch] || ch);
  return s;
}

/* ===== modal ===== */
function openRowModal(rowObj){
  const modal = document.getElementById('rowModal');
  const title = document.getElementById('rmTitle');
  const body = document.getElementById('rmBody');

  title.textContent = rowObj.vehicleNumber ? `Номер: ${rowObj.vehicleNumber}` : 'Детали';

  const fields = [
    ['Тип', rowObj.type],
    ['Модель', rowObj.model],
    ['Год', rowObj.year],
    ['Дата', rowObj.deliveryDate],
    ['Парк', rowObj.park],
    ['Номер', rowObj.vehicleNumber],
    ['Заводской №', rowObj.factoryNumber],
    ['Гаражный №', rowObj.garageNumber],
    ['Цвет', rowObj.color],
  ];

  body.innerHTML = fields.map(([k,v])=>`
    <div class="rm-row">
      <div class="rm-k">${escapeHTML(k)}</div>
      <div class="rm-v">${escapeHTML(((v||'—').toString()) || '—')}</div>
    </div>
  `).join('');

  modal.style.display = '';
  // IMPORTANT: in iframe лучше блокировать body, не documentElement
  document.body.style.overflow = 'hidden';
}
function closeRowModal(){
  const modal = document.getElementById('rowModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

document.getElementById('rmClose').addEventListener('click', closeRowModal);
document.querySelector('#rowModal .rm-backdrop').addEventListener('click', closeRowModal);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeRowModal(); });

/* ===== render ===== */
function render(){
  const colFilters = {};
  document.querySelectorAll('.colFilter').forEach(inp=>{
    const col = inp.getAttribute('data-col');
    const val = (inp.value || '').toString().trim();
    if(val) colFilters[col] = val;
  });

  VIEW = DATA
    .filter(v=>{
      if(activeTab === '_new'){
        if(!newMonthKey) return false;
        const mk = monthKeyFromDeliveryDate(v.deliveryDate);
        if(mk !== newMonthKey) return false;
      }
      if(activeTab !== '_new' && activeTab !== '_all'){
        if(normType(v.type) !== activeTab) return false;
      }
      for(const [col, rawNeedle] of Object.entries(colFilters)){
        const needle = rawNeedle.toString().toLowerCase();

        if(col === 'type'){
          const hay = typeLabel(v.type).toLowerCase();
          if(!hay.includes(needle)) return false;
          continue;
        }

        if(col === 'vehicleNumber'){
          const hay = normVehicleNumberForSearch(v.vehicleNumber);
          const n = normVehicleNumberForSearch(rawNeedle);
          if(!hay.includes(n)) return false;
          continue;
        }

        const hay = (v[col] || '').toString().toLowerCase();
        if(!hay.includes(needle)) return false;
      }
      return true;
    })
    .sort(generalSort);

  document.getElementById('countShown').textContent = VIEW.length;
  document.getElementById('countAll').textContent = DATA.length;

  const tbody = document.getElementById('data');
  const empty = document.getElementById('empty');

  if(!VIEW.length){
    tbody.innerHTML = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = VIEW.map(v=>{
    const payloadObj = {
      type: typeLabel(v.type),
      model: (v.model||''),
      year: (v.year||''),
      deliveryDate: (v.deliveryDate||''),
      park: (v.park||''),
      vehicleNumber: (v.vehicleNumber||''),
      factoryNumber: (v.factoryNumber||''),
      garageNumber: (v.garageNumber||''),
      color: (v.color||'')
    };
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(payloadObj))));

    return `<tr data-rowb64="${payload}">
      <td>${escapeHTML(typeLabel(v.type))}</td>
      <td>${cell(v.model)}</td>
      <td>${cell(v.year)}</td>
      <td>${cell(v.deliveryDate)}</td>
      <td>${cell(v.park)}</td>
      <td class="num">${cell(v.vehicleNumber)}</td>
      <td>${cell(v.factoryNumber)}</td>
      <td>${cell(v.garageNumber)}</td>
      <td>${cell(v.color)}</td>
    </tr>`;
  }).join('');
}

/* sort click (avoid when resizing) */
function initSortClick(){
  document.querySelectorAll('th[data-f]').forEach(th=>{
    th.onclick = (e)=>{
      if(e.target && e.target.classList && e.target.classList.contains('resizer')) return;

      document.querySelectorAll('th[data-f]').forEach(t=>t.classList.remove('active'));
      th.classList.add('active');

      const f = th.getAttribute('data-f');
      if(sortF === f) sortDesc = !sortDesc;
      else {
        sortF = f;
        sortDesc = (f === "vehicleNumber") ? true : false;
      }
      render();
    };
  });
}

/* filters input */
document.addEventListener('input', (e) => {
  if(e.target && e.target.classList && e.target.classList.contains('colFilter')){
    render();
  }
});

/* ===== tap-to-open without breaking scroll ===== */
(function initRowTap(){
  const tbody = document.getElementById('data');
  let start = null;
  const TAP_MAX_MOVE = 12; // px
  const TAP_MAX_TIME = 500; // ms

  tbody.addEventListener('pointerdown', (e)=>{
    const tr = e.target.closest('tr');
    if(!tr) return;
    start = { x: e.clientX, y: e.clientY, t: Date.now(), tr };
  }, {passive:true});

  tbody.addEventListener('pointerup', (e)=>{
    if(!start) return;
    const tr = e.target.closest('tr');
    if(!tr || tr !== start.tr){ start = null; return; }

    const dx = Math.abs(e.clientX - start.x);
    const dy = Math.abs(e.clientY - start.y);
    const dt = Date.now() - start.t;
    start = null;

    // если это был скролл/свайп — не открываем
    if(dx > TAP_MAX_MOVE || dy > TAP_MAX_MOVE || dt > TAP_MAX_TIME) return;

    const b64 = tr.getAttribute('data-rowb64');
    if(!b64) return;
    try{
      const txt = decodeURIComponent(escape(atob(b64)));
      const obj = JSON.parse(txt);
      openRowModal(obj);
    }catch{}
  }, {passive:true});
})();

/* ===== errors ===== */
function showErr(msg){
  const e = document.getElementById('err');
  e.style.display = '';
  e.textContent = msg;
}
function hideErr(){
  const e = document.getElementById('err');
  e.style.display = 'none';
  e.textContent = '';
}

/* ===== json load ===== */
function pickArray(j){
  if(Array.isArray(j)) return j;
  if(j && Array.isArray(j.vehicles)) return j.vehicles;
  if(j && Array.isArray(j.data)) return j.data;
  if(j && Array.isArray(j.items)) return j.items;
  return [];
}
function mapRow(r){
  return {
    type: r.type || '',
    model: r.model || '',
    year: r.year || '',
    deliveryDate: r.deliveryDate || '',
    park: r.park || '',
    vehicleNumber: (r.licensePlate || r.registrationNumber || r.vehicleNumber || ''),
    factoryNumber: r.factoryNumber || '',
    garageNumber: r.garageNumber || '',
    color: r.color || ''
  };
}
async function loadJson(){
  try{
    hideErr();
    const r = await fetch(JSON_URL, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();

    const arr = pickArray(j);
    const updatedAt = (j && !Array.isArray(j) && j.updatedAt) ? j.updatedAt : '';

    DATA = arr.map(mapRow);
    document.getElementById('updatedAt').textContent = updatedAt ? ('Обновлено: ' + updatedAt) : '';

    computeNewMonthKey();

    activeTab = "_new";
    sortF = "vehicleNumber";
    sortDesc = true;

    renderTabs();
    render();
  } catch(err){
    DATA = [];
    renderTabs();
    render();
    showErr('Не загрузился ' + JSON_URL + ' — ' + err.message);
  }
}

/* ===== Column resizing (desktop only) ===== */
function getStoredColWidths(){
  try{
    const raw = localStorage.getItem(COLS_STORAGE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== 'object') return null;
    return obj;
  }catch{
    return null;
  }
}
function setStoredColWidths(obj){
  try{ localStorage.setItem(COLS_STORAGE_KEY, JSON.stringify(obj)); }catch{}
}
function getColEls(){
  const tbl = document.getElementById('tbl');
  if(!tbl) return [];
  return Array.from(tbl.querySelectorAll('colgroup col[data-colkey]'));
}
function applyStoredColWidths(){
  const saved = getStoredColWidths();
  if(!saved) return;
  getColEls().forEach(col=>{
    const key = col.getAttribute('data-colkey');
    const px = saved[key];
    if(typeof px === 'number' && px >= 30){
      col.style.width = px + 'px';
    }
  });
}
function initColumnResizersDesktopOnly(){
  if(window.innerWidth < ENABLE_RESIZE_MIN_WIDTH) return; // IMPORTANT

  const tbl = document.getElementById('tbl');
  if(!tbl) return;

  const ths = Array.from(tbl.querySelectorAll('thead tr:first-child th[data-colkey]'));
  const cols = getColEls();
  const colByKey = new Map(cols.map(c => [c.getAttribute('data-colkey'), c]));

  ths.forEach((th, idx)=>{
    if(idx === ths.length - 1) return;
    if(th.querySelector('.resizer')) return;

    const r = document.createElement('div');
    r.className = 'resizer';
    r.setAttribute('data-colkey', th.getAttribute('data-colkey'));
    th.appendChild(r);
  });

  let drag = null;

  function onPointerMove(e){
    if(!drag) return;
    const dx = e.clientX - drag.startX;
    const newW = Math.max(drag.minW, drag.startW + dx);

    drag.colEl.style.width = newW + 'px';

    const saved = getStoredColWidths() || {};
    saved[drag.colKey] = newW;
    setStoredColWidths(saved);
  }

  function stopDrag(){
    if(!drag) return;
    document.body.classList.remove('resizing');
    try{ drag.resizer.releasePointerCapture(drag.pointerId); }catch{}
    drag = null;
    window.removeEventListener('pointermove', onPointerMove);
    window.removeEventListener('pointerup', stopDrag);
    window.removeEventListener('pointercancel', stopDrag);
  }

  tbl.addEventListener('pointerdown', (e)=>{
    const target = e.target;
    if(!target || !target.classList || !target.classList.contains('resizer')) return;

    e.preventDefault();
    e.stopPropagation();

    const colKey = target.getAttribute('data-colkey');
    const colEl = colByKey.get(colKey);
    if(!colEl) return;

    const th = target.closest('th');
    const rect = th.getBoundingClientRect();

    drag = {
      pointerId: e.pointerId,
      resizer: target,
      colKey,
      colEl,
      startX: e.clientX,
      startW: rect.width,
      minW: 45
    };

    document.body.classList.add('resizing');
    target.setPointerCapture(e.pointerId);

    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', stopDrag);
    window.addEventListener('pointercancel', stopDrag);
  }, {passive:false});
}

function resetColWidths(){
  localStorage.removeItem(COLS_STORAGE_KEY);
  getColEls().forEach(col => col.style.width = '');
}

/* ===== boot ===== */
initSortClick();
applyStoredColWidths();
initColumnResizersDesktopOnly();

document.getElementById('btnResetCols').onclick = ()=>{
  resetColWidths();
};

renderTabs();
loadJson();
</script>
</body>
</html>
