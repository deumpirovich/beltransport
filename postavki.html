<!-- postavki.html (полный код: центрирование, sticky поиск+табы, sticky шапка таблицы) -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Транспорт Минска — поставки</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; background: #f5f7fa; color: #23263a; margin: 0; padding: 0;}
    .cont { max-width: 1100px; margin: 15px auto; padding: 0 10px; }

    /* ====== закрепляем верх (поиск + табы) ====== */
    .stickyTop{
      position: sticky;
      top: 0;
      z-index: 50;
      background: #f5f7fa;
      padding-top: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e3e8f5;
    }

    .msg {color:#b25127;margin:5px 0;}
    .topbar{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .search {margin:6px 0 7px 0; display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    input[type="text"] {padding:4px 9px; font-size:13px; border-radius:5px; border:1px solid #bbc; width:260px;}
    .tabs{display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 4px 0;}
    .tab{padding:3px 10px; border-radius:10px; border:1px solid #cfd7ea; background:#eef3ff; cursor:pointer; user-select:none; font-size:12px;}
    .tab.active{background:#2543a5; color:#fff; border-color:#2543a5;}
    .counts{color:#5b6b98; font-size:12px; margin-left:auto;}

    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size:13px;}

    /* ====== центрируем ВСЕ данные ====== */
    th, td { padding: 3px 5px; text-align: center; }

    /* ====== закрепляем шапку таблицы ======
       ВАЖНО: top должен быть равен высоте .stickyTop.
       Я сделал переменную --stickyTopOffset, чтобы можно было подправить в одном месте. */
    :root{
      --stickyTopOffset: 122px; /* если вдруг не идеально — скажи, подгоним под твою высоту */
    }
    thead th{
      position: sticky;
      top: var(--stickyTopOffset);
      z-index: 40;
      background: #ecf1fa;
      border-bottom:1.5px solid #abc;
    }

    th { color: #2543a5; font-weight: 600; cursor: pointer; user-select: none; }
    th.active { background: #d2e3ff; }
    tr { border-bottom: 1px solid #eee;}
    tr:hover { background: #f0f5ff;}
    .num { font-weight: bold; color: #2543a5; }
    .no { color:#bbb; font-style:italic; }
    .empty {padding:18px 0; text-align:center; color:#9aa6c3; font-style:italic;}
    .err {margin-top:8px; padding:6px 10px; background:#ffecec; border:1px solid #f2b0b0; border-radius:6px; color:#8b1e1e; font-size:12px; white-space:pre-wrap;}

    @media (max-width: 560px){
      input[type="text"]{width: 100%;}
      :root{ --stickyTopOffset: 150px; } /* на мобилках верх обычно выше из-за переносов */
    }
  </style>
</head>
<body>
<div class="cont">

  <!-- ЗАКРЕПЛЕННЫЙ БЛОК: сообщение + поиск + tabs -->
  <div class="stickyTop" id="stickyTop">
    <div class="topbar">
      <div class="msg">
        Поиск через запятую (“и”): <b>маз, 2025</b>
        <span id="monthHint" style="color:#5b6b98;"></span>
      </div>
      <div class="counts"><span id="countShown">0</span> / <span id="countAll">0</span></div>
    </div>

    <div class="search">
      <input id="q" type="text" placeholder="Поиск...">
      <div style="color:#5b6b98;font-size:12px;" id="updatedAt"></div>
    </div>

    <div class="tabs" id="tabs"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th data-f="type">Тип</th>
        <th data-f="model">Модель</th>
        <th data-f="year">Год</th>
        <th data-f="deliveryDate">Дата</th>
        <th data-f="park">Парк</th>
        <th data-f="vehicleNumber" class="active">Номер</th>
        <th data-f="factoryNumber">Заводской №</th>
        <th data-f="garageNumber">Гаражный №</th>
        <th data-f="color">Цвет</th>
      </tr>
    </thead>
    <tbody id="data"></tbody>
  </table>

  <div class="empty" id="empty" style="display:none;">Нет данных по фильтру</div>
  <div class="err" id="err" style="display:none;"></div>
</div>

<script>
const JSON_URL = './postavki.json';

let DATA = [];
let VIEW = [];
let sortF = "vehicleNumber";
let sortDesc = true;
let activeTab = "_all";
let allTabMonthKey = ''; // последний месяц с данными (для таба "Все")

/** === автоматически подгоняем top для sticky шапки === */
function updateStickyHeaderOffset(){
  const top = document.getElementById('stickyTop');
  if(!top) return;
  const h = Math.ceil(top.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--stickyTopOffset', h + 'px');
}
window.addEventListener('resize', updateStickyHeaderOffset);

/** ===== month helpers ===== */
function pad2(n){ return String(n).padStart(2,'0'); }
function monthKeyFromDeliveryDate(s){
  const m = String(s||'').trim().match(/^(\d{1,2})\.(\d{4})$/);
  if(!m) return '';
  return `${pad2(m[1])}.${m[2]}`;
}
function computeAllTabMonthKeyLatest(){
  const set = new Set();
  DATA.forEach(v=>{
    const mk = monthKeyFromDeliveryDate(v.deliveryDate);
    if(mk) set.add(mk);
  });
  if(!set.size){
    allTabMonthKey = '';
    document.getElementById('monthHint').textContent = '';
    return;
  }
  const best = [...set].sort((a,b)=>{
    const [am,ay]=a.split('.'); const [bm,by]=b.split('.');
    return Number(by+bm) - Number(ay+am);
  })[0];
  allTabMonthKey = best;
  document.getElementById('monthHint').textContent = ` | “Все”: ${allTabMonthKey}`;
}

/** ===== types ===== */
function normType(t){
  t = (t||'').toString().trim().toLowerCase();
  if(t === 'уах') t = 'туах';
  return t;
}
function typeLabel(t){
  t = normType(t);
  if(t === 'автобус') return 'Автобус';
  if(t === 'троллейбус') return 'Троллейбус';
  if(t === 'трамвай') return 'Трамвай';
  if(t === 'электробус') return 'Электробус';
  if(t === 'туах') return 'ТУАХ';
  return t ? (t[0].toUpperCase()+t.slice(1)) : '—';
}

const TAB_ORDER = [
  {key:'_all', label:'Все'},
  {key:'автобус', label:'Автобус'},
  {key:'троллейбус', label:'Троллейбус'},
  {key:'трамвай', label:'Трамвай'},
  {key:'электробус', label:'Электробус'},
  {key:'туах', label:'ТУАХ'}
];

function calcTypeCounts(){
  const m = {};
  DATA.forEach(v=>{
    const t = normType(v.type);
    if(!t) return;
    m[t] = (m[t]||0)+1;
  });
  return m;
}

function renderTabs(){
  const wrap = document.getElementById('tabs');
  const counts = calcTypeCounts();
  wrap.innerHTML = TAB_ORDER.map(t => {
    const c = (t.key === '_all') ? DATA.length : (counts[t.key]||0);
    return `<div class="tab ${activeTab===t.key?'active':''}" data-tab="${t.key}">
      ${t.label} <span style="opacity:.75;">${c}</span>
    </div>`;
  }).join('');

  wrap.querySelectorAll('.tab').forEach(el=>{
    el.onclick = ()=>{
      activeTab = el.getAttribute('data-tab');
      renderTabs();
      render();
    };
  });
}

/** ===== sort ===== */
function numSortAlg(a, b){
  let an = (a.vehicleNumber||'').toUpperCase(), bn = (b.vehicleNumber||'').toUpperCase();
  if (!an && !bn) return 0; if (!an) return 1; if (!bn) return -1;

  let aB = (an.length>=3 && !/\d/.test(an[2])) ? 1 : 0;
  let bB = (bn.length>=3 && !/\d/.test(bn[2])) ? 1 : 0;
  if (aB !== bB) return bB - aB;

  return an > bn ? -1 : an < bn ? 1 : 0; // desc
}
function generalSort(a, b){
  if(sortF === "vehicleNumber") {
    let r = numSortAlg(a, b);
    return sortDesc ? r : -r;
  }
  let av=(a[sortF]||'').toLowerCase(), bv=(b[sortF]||'').toLowerCase();
  if(av < bv) return sortDesc ? 1 : -1;
  if(av > bv) return sortDesc ? -1 : 1;
  return numSortAlg(a, b);
}

/** ===== render ===== */
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function cell(x){
  const s = (x||'').toString().trim();
  return s ? escapeHTML(s) : '<span class="no">—</span>';
}

function render(){
  const q = document.getElementById('q').value.trim();
  const filters = q ? q.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean) : [];

  VIEW = DATA
    .filter(v=>{
      if(activeTab !== '_all' && normType(v.type) !== activeTab) return false;

      if(activeTab === '_all' && allTabMonthKey){
        const mk = monthKeyFromDeliveryDate(v.deliveryDate);
        if(mk !== allTabMonthKey) return false;
      }

      if(filters.length){
        const vals = Object.values(v).map(x => (x||'').toString().toLowerCase());
        return filters.every(f => vals.some(val => val.includes(f)));
      }
      return true;
    })
    .sort(generalSort);

  document.getElementById('countShown').textContent = VIEW.length;
  document.getElementById('countAll').textContent = DATA.length;

  const tbody = document.getElementById('data');
  const empty = document.getElementById('empty');

  if(!VIEW.length){
    tbody.innerHTML = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = VIEW.map(v=>`<tr>
    <td>${escapeHTML(typeLabel(v.type))}</td>
    <td>${cell(v.model)}</td>
    <td>${cell(v.year)}</td>
    <td>${cell(v.deliveryDate)}</td>
    <td>${cell(v.park)}</td>
    <td class="num">${cell(v.vehicleNumber)}</td>
    <td>${cell(v.factoryNumber)}</td>
    <td>${cell(v.garageNumber)}</td>
    <td>${cell(v.color)}</td>
  </tr>`).join('');
}

/** ===== header click sort ===== */
document.querySelectorAll('th[data-f]').forEach(th=>{
  th.onclick = ()=>{
    document.querySelectorAll('th[data-f]').forEach(t=>t.classList.remove('active'));
    th.classList.add('active');
    const f = th.getAttribute('data-f');
    if(sortF === f) sortDesc = !sortDesc;
    else {
      sortF = f;
      sortDesc = (f === "vehicleNumber") ? true : false;
    }
    render();
  };
});
document.getElementById('q').oninput = render;

/** ===== error ui ===== */
function showErr(msg){
  const e = document.getElementById('err');
  e.style.display = '';
  e.textContent = msg;
}
function hideErr(){
  const e = document.getElementById('err');
  e.style.display = 'none';
  e.textContent = '';
}

/** ===== json load ===== */
function pickArray(j){
  if(Array.isArray(j)) return j;
  if(j && Array.isArray(j.vehicles)) return j.vehicles;
  if(j && Array.isArray(j.data)) return j.data;
  if(j && Array.isArray(j.items)) return j.items;
  return [];
}
function mapRow(r){
  return {
    type: r.type || '',
    model: r.model || '',
    year: r.year || '',
    deliveryDate: r.deliveryDate || '',
    park: r.park || '',
    vehicleNumber: (r.licensePlate || r.registrationNumber || r.vehicleNumber || ''),
    factoryNumber: r.factoryNumber || '',
    garageNumber: r.garageNumber || '',
    color: r.color || ''
  };
}

async function loadJson(){
  try{
    hideErr();
    const r = await fetch(JSON_URL, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();

    const arr = pickArray(j);
    const updatedAt = (j && !Array.isArray(j) && j.updatedAt) ? j.updatedAt : '';

    DATA = arr.map(mapRow);

    document.getElementById('updatedAt').textContent = updatedAt ? ('Обновлено: ' + updatedAt) : '';

    computeAllTabMonthKeyLatest();
    activeTab = "_all";
    sortF = "vehicleNumber";
    sortDesc = true;

    renderTabs();
    render();

    // после того как табы/updatedAt отрисовались — пересчитываем высоту stickyTop
    requestAnimationFrame(updateStickyHeaderOffset);
  } catch(err){
    DATA = [];
    renderTabs();
    render();
    showErr('Не загрузился ' + JSON_URL + ' — ' + err.message);
    requestAnimationFrame(updateStickyHeaderOffset);
  }
}

renderTabs();
loadJson();
</script>
</body>
</html>
