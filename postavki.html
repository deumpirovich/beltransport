<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Транспорт Минска — просмотр</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; background: #f5f7fa; color: #23263a; margin: 0; padding: 0;}
    .cont { max-width: 1100px; margin: 15px auto; }
    .search {margin-bottom: 7px;}
    input[type="text"] {padding:4px 9px; font-size:13px; border-radius:5px; border:1px solid #bbc;}
    table { width: 100%; border-collapse: collapse; margin-top: 2px; font-size:13px;}
    th, td { padding: 3px 5px;}
    th { background: #ecf1fa; color: #2543a5; font-weight: 600; cursor: pointer; user-select: none; border-bottom:1.5px solid #abc;}
    th.active { background: #d2e3ff; }
    tr { border-bottom: 1px solid #eee;}
    tr:hover { background: #f0f5ff;}
    .num { font-weight: bold; color: #2543a5; }
    .no { color:#bbb; font-style:italic; }
    .msg {color:#b25127;margin:5px 0;}
  </style>
</head>
<body>
<div class="cont">
  <div class="msg">Поиск через запятую (“и”): <b>маз, 2025</b> — ищет по всем словам.</div>
  <div class="search">
    <input id="q" type="text" placeholder="Поиск...">
    <input type="file" id="jsonFile" style="margin-left:15px;">
  </div>
  <table>
    <thead>
      <tr>
        <th data-f="type">Тип</th>
        <th data-f="model">Модель</th>
        <th data-f="year">Год</th>
        <th data-f="deliveryDate">Дата</th>
        <th data-f="park">Парк</th>
        <th data-f="vehicleNumber" class="active">Номер</th>
        <th data-f="factoryNumber">Заводской №</th>
        <th data-f="garageNumber">Гаражный №</th>
        <th data-f="color">Цвет</th>
      </tr>
    </thead>
    <tbody id="data"></tbody>
  </table>
</div>
<script>
let DATA = [];
let sortF = "vehicleNumber", sortDesc = true;

function numSortAlg(a, b){
  let an = (a.vehicleNumber||'').toUpperCase(), bn = (b.vehicleNumber||'').toUpperCase();
  if (!an && !bn) return 0; if (!an) return 1; if (!bn) return -1;
  let aB = (an.length>=3 && !/\d/.test(an[2])) ? 1 : 0, bB = (bn.length>=3 && !/\d/.test(bn[2])) ? 1 : 0;
  if (aB !== bB) return bB - aB; // буква на 3 позиции — выше
  return an > bn ? -1 : an < bn ? 1 : 0;
}
function generalSort(a, b){
  if(sortF === "vehicleNumber") { let r = numSortAlg(a, b); return sortDesc ? r : -r; }
  let av=(a[sortF]||'').toLowerCase(), bv=(b[sortF]||'').toLowerCase();
  if(av < bv) return sortDesc ? 1 : -1;
  if(av > bv) return sortDesc ? -1 : 1;
  return numSortAlg(a, b);
}
function render(){
  let q = document.getElementById('q').value.trim();
  let filters = q ? q.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean) : [];
  let view = DATA.filter(v => {
    return filters.every(f => Object.values(v).some(x => (x||'').toLowerCase().includes(f)));
  }).sort(generalSort);
  let html = "";
  view.forEach(v=>{
    html += `<tr>
      <td>${v.type||'<span class="no">—</span>'}</td>
      <td>${v.model||'<span class="no">—</span>'}</td>
      <td>${v.year||'<span class="no">—</span>'}</td>
      <td>${v.deliveryDate||'<span class="no">—</span>'}</td>
      <td>${v.park||'<span class="no">—</span>'}</td>
      <td class="num">${v.vehicleNumber||'<span class="no">—</span>'}</td>
      <td>${v.factoryNumber||'<span class="no">—</span>'}</td>
      <td>${v.garageNumber||'<span class="no">—</span>'}</td>
      <td>${v.color||'<span class="no">—</span>'}</td>
    </tr>`;
  });
  document.getElementById('data').innerHTML = html;
}
document.getElementById('q').oninput = render;
document.querySelectorAll('th[data-f]').forEach(th=>{
  th.onclick = ()=>{
    document.querySelectorAll('th[data-f]').forEach(t=>t.classList.remove('active'));
    th.classList.add('active');
    let f = th.getAttribute('data-f');
    if(sortF === f) sortDesc = !sortDesc; else { sortF = f; sortDesc = f==="vehicleNumber"?true:false; }
    render();
  }
});
document.getElementById('jsonFile').onchange = function(){
  let file = this.files[0];
  let reader = new FileReader();
  reader.onload = function(e){
    try {
      let json = JSON.parse(e.target.result);
      let arr = Array.isArray(json) ? json : (json.vehicles||[]);
      DATA = arr.map(r=>({
        type: r.type||'', model: r.model||'', year: r.year||'', deliveryDate: r.deliveryDate||'', park: r.park||'',
        vehicleNumber: r.licensePlate||r.registrationNumber||'', factoryNumber: r.factoryNumber||'',
        garageNumber: r.garageNumber||'', color: r.color||''
      }));
      render();
    } catch(e){alert('Ошибка при чтении файла: '+e);}
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
